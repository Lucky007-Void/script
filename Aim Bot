local player = game.Players.LocalPlayer
local uis = game:GetService("UserInputService")
local runService = game:GetService("RunService")
local camera = workspace.CurrentCamera

local locking = false
local target = nil
local FOV = 100 -- ระยะรัศมี FOV (pixel)
local smoothness = 0.5 -- 0.01 (ช้า) - 1 (เร็ว)

--// วงกลม FOV (ใช้ Drawing API)
local fovCircle = Drawing.new("Circle")
fovCircle.Visible = true
fovCircle.Thickness = 2
fovCircle.Color = Color3.fromRGB(255, 255, 255)
fovCircle.Radius = FOV
fovCircle.Filled = false
fovCircle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)

-- ฟังก์ชันตรวจสอบว่ามีผนังกั้นหรือไม่
local function canSee(targetPosition)
    local rayOrigin = camera.CFrame.Position
    local rayDirection = (targetPosition - rayOrigin).Unit * (targetPosition - rayOrigin).Magnitude
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {player.Character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist

    local raycastResult = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
    if raycastResult then
        return raycastResult.Instance:IsDescendantOf(player.Character) == false 
            and raycastResult.Position:FuzzyEq(targetPosition, 0.1)
    end
    return true
end

-- ฟังก์ชันหาผู้เล่นที่ใกล้กลางหน้าจอที่สุดใน FOV
local function getClosestPlayerInFOV()
    local closest = nil
    local closestDist = FOV

    local center = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)

    for _, p in pairs(game.Players:GetPlayers()) do
        if p ~= player and p.Character and p.Character:FindFirstChild("Head") then
            local head = p.Character.Head
            local screenPos, onScreen = camera:WorldToViewportPoint(head.Position)
            if onScreen then
                local dist = (center - Vector2.new(screenPos.X, screenPos.Y)).Magnitude
                if dist < closestDist and canSee(head.Position) then
                    closest = head
                    closestDist = dist
                end
            end
        end
    end

    return closest
end

-- เริ่มล็อคเมื่อกดปุ่ม T
uis.InputBegan:Connect(function(input, gameProcessed)
    if not gameProcessed and input.KeyCode == Enum.KeyCode.T then
        locking = true
    end
end)

-- ปล่อยล็อคเมื่อปล่อยปุ่ม T
uis.InputEnded:Connect(function(input)
    if input.KeyCode == Enum.KeyCode.T then
        locking = false
        target = nil
    end
end)

-- อัพเดตทุกเฟรม
runService.RenderStepped:Connect(function()
    -- อัพเดตตำแหน่งและรัศมี FOV
    fovCircle.Position = Vector2.new(camera.ViewportSize.X/2, camera.ViewportSize.Y/2)
    fovCircle.Radius = FOV

    if locking then
        target = getClosestPlayerInFOV()
        if target then
            local currentCFrame = camera.CFrame
            local targetCFrame = CFrame.new(currentCFrame.Position, target.Position)
            camera.CFrame = currentCFrame:Lerp(targetCFrame, smoothness)
        end
    end
end)
