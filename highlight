-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

local localPlayer = Players.LocalPlayer -- ผู้เล่นตัวเอง

-- สร้าง Folder สำหรับเก็บ Highlight
local highlightFolder = Workspace:FindFirstChild("HighlightContainer")
if not highlightFolder then
    highlightFolder = Instance.new("Folder")
    highlightFolder.Name = "HighlightContainer"
    highlightFolder.Parent = Workspace
end

-- ฟังก์ชันสร้าง Highlight ให้กับ Player
local function addESP(player)
    -- ไม่ทำกับตัวเอง
    if player == localPlayer then
        return
    end

    -- ตรวจสอบว่า Character มีอยู่ และยังไม่มี Highlight
    if player.Character and not highlightFolder:FindFirstChild(player.Name .. "_ESP") then
        local highlight = Instance.new("Highlight")
        highlight.Name = player.Name .. "_ESP"
        highlight.Adornee = player.Character
        highlight.FillColor = Color3.fromRGB(255, 0, 0) -- สีแดง
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255) -- สีขาว
        highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop -- มองทะลุ
        highlight.Parent = highlightFolder
    end
end

-- ฟังก์ชันลบ Highlight ของ Player ที่ออก
local function removeESP(player)
    local highlight = highlightFolder:FindFirstChild(player.Name .. "_ESP")
    if highlight then
        highlight:Destroy()
    end
end

-- Event สำหรับผู้เล่นเข้ามา
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        addESP(player)
    end)
end)

-- Event สำหรับผู้เล่นออก
Players.PlayerRemoving:Connect(removeESP)

-- สร้าง ESP ให้ผู้เล่นที่อยู่แล้วตอนเริ่มเกม
for _, player in pairs(Players:GetPlayers()) do
    if player ~= localPlayer and player.Character then
        addESP(player)
    end
    player.CharacterAdded:Connect(function()
        addESP(player)
    end)
end

-- อัปเดต Highlight ทุกเฟรม
RunService.RenderStepped:Connect(function()
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= localPlayer and player.Character then
            local highlight = highlightFolder:FindFirstChild(player.Name .. "_ESP")
            if highlight then
                highlight.Adornee = player.Character
            end
        end
    end
end)
